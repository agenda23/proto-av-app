# VJ風Webアプリケーション 仕様書

## 1. システムアーキテクチャ

本アプリケーションは、以下の3つのレイヤーと1つのコントローラーで構成される。

- **3Dレイヤー (Three.js)**: 背景およびメインの3Dビジュアルを担当。
- **2Dレイヤー (p5.js)**: 前景のUI、デバッグ情報、シンプルな2Dエフェクトを担当。
- **オーディオエンジン (p5.js - p5.sound)**: 全てのサウンド生成とオーディオ分析を担当。
- **メインコントローラー (JavaScript)**: ユーザー入力を受け付け、オーディオエンジンからのデータを各ビジュアルレイヤーに橋渡しする。

![Architecture Diagram](https://i.imgur.com/8aV4i3y.png)

## 2. 機能詳細仕様

### 2.1. オーディオエンジン
- **サウンドソース**: `p5.Oscillator` (サイン波、矩形波)、`p5.Noise` (ホワイトノイズ)。
- **音色**:
    - **キック**: 低周波サイン波 (60Hz) + 急峻なピッチと音量のエンベロープ。
    - **ハイハット**: ホワイトノイズ + バンドパスフィルター + 短いエンベロープ。
    - **ベースシンセ**: 矩形波オシレーター + ローパスフィルター。
- **シーケンサー**:
    - 16ステップシーケンサー。
    - 初期BPM: 128。BPMは±5ずつ調整可能。
- **オーディオ分析 (`p5.FFT`)**:
    - FFTサイズ: 1024。
    - 分析データ:
        - `bass`: 20Hz - 250Hz帯域のエネルギー平均値。
        - `mid`: 251Hz - 4000Hz帯域のエネルギー平均値。
        - `treble`: 4001Hz - 16000Hz帯域のエネルギー平均値。
        - `waveform`: 時間領域の波形データ配列。

### 2.2. ビジュアルエンジン (3D - Three.js)
- **シーン1: "Pulsar"**
    - 中央に`IcosahedronGeometry`を配置。
    - `bass`値に応じて、ジオメトリのスケールが変化。
    - `bass`値に応じて、マテリアルの`emissive`（自己発光）色が白から赤へ変化。
- **シーン2: "Particle Storm"**
    - 5000個の`THREE.Points`で構成されるパーティクル群。
    - `mid`値に応じて、各パーティクルの速度とパーリンノイズによる動きの複雑さが変化。
    - 全体の音量に応じて、パーティクルのサイズが変化。
- **シーン3: "Shader Tunnel"**
    - `CylinderGeometry`の内側にカメラを配置し、トンネル内を進むビューを作成。
    - マテリアルには`ShaderMaterial`を使用。
    - GLSLシェーダーでフラクタルノイズによる有機的な模様を生成。
    - `treble`値に応じて、シェーダー内のノイズの歪み（`distortion`）の係数が変化する。

### 2.3. ビジュアルエンジン (2D - p5.js)
- **UI表示**:
    - 左上に現在のシーン名（"Pulsar", "Particle Storm", "Shader Tunnel"）を表示。
    - 右上に現在のBPMを表示。
- **デバッグ表示 (オプションでON/OFF)**:
    - 画面下部にFFTの`bass`, `mid`, `treble`をバーで表示するスペクトラムアナライザ。
    - `waveform`データを線で描画するオシロスコープ。

### 2.4. インタラクション
- **キーボード**:
    - `1`, `2`, `3`: 対応する3Dビジュアルシーンに切り替え。
    - `S`: シーケンサーの再生/停止。
    - `A` / `D`: BPMを-5 / +5する。
    - `Q, W, E, R, T, Y`: ベースシンセの音階を演奏する。
- **マウス/タッチ**:
    - **クリック/タップ**: 画面上のクリック位置から`mid`値に応じた数のパーティクルが放射状に広がるエフェクトをp5.jsレイヤーで描画。
    - **ドラッグ**: シーン1と2において、マウスドラッグでカメラのアークボール回転操作が可能。